# -*- coding: utf-8 -*-
"""3102

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1IXEm1zNLnixFUsxJcRUzAh3udYYfk8kb
"""

import anvil.server # import Anvil server lib
import anvil.media
import anvil
anvil.server.connect("AUNCATU3SXUIECPC3KKECHWE-LSGS34RAIS5QGAFE") # Connection uplink to Anvil Front End
from urllib.parse import urljoin
import requests
import base64
import os
import time
import urllib.parse
from time import perf_counter
import cProfile

#################################################################
######################### QandA Modules #########################
#################################################################
@anvil.server.callable
def QandA_Generated(image):
    start = perf_counter()
    # image argument should be the image object pass from the user
    # This function should then call the other function for Caption, Ques and Ans
    # Caption Function call
    Cap = Caption_Function(image)
    # Answer Function call
    Result = QnA_Function(caption=Cap)
    Ans = Result[1]
    Ques = Result[0]
    
    # This should return the Caption, Question and Answer
    QA_Generated = [Cap, Ans, Ques] # test code excutable
    duration = perf_counter() - start
    print("QandA Generator Time: ", duration)
    return(QA_Generated)

@anvil.server.callable
def Caption_Function(image):
    start = perf_counter()
    url = 'http://captions:8080/image_captioning'
    files = {'img': image.get_bytes()}
    r = requests.post(url, files=files)
    # extracting data in json format
    data = r.json()
    duration = perf_counter() - start
    print("Caption Function Time: ", duration)
    return data['caption'] # Return text(str) for caption of image


@anvil.server.callable
def QnA_Function(caption):
    start = perf_counter()
    # caption = 'The herb is generally safe to use. There is limited research to suggest that stinging nettle is an effective remedy. Researchers need to do more studies before they can confirm the health benefits of stinging nettle.'
    # sending get request and saving the response as response object
    payload = {'captions': caption}
    QnA_Response = requests.get('http://Transformer:8888/transformer', params=payload)
    # extracting data in json format
    data = QnA_Response.json()
    for i in data:
        Question = f"{i['question']}"
        Answer = f"{i['answer']}"
        Q = Question
        A = Answer
    duration = perf_counter() - start
    print("QnA Function Time: ", duration)
    return [Q, A] # Return text(str) for Answer for image

#################################################################
###### Set this sever to wait forever like a restful API ########
#################################################################
anvil.server.wait_forever()

# Simple Check code of available lib in environment
# !pip freeze
